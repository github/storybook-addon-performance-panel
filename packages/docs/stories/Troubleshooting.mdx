import {Meta} from '@storybook/addon-docs/blocks'

<Meta title="Guides/Troubleshooting" />

# Troubleshooting Guide

## Quick Health Check

Start by scanning these key indicators:

| Check | What to Look For |
|-------|------------------|
| **FPS** | Should be 55‚Äì60. Sustained drops indicate rendering issues |
| **INP** | Should be &lt;200ms. High values mean slow user interactions |
| **Long Tasks** | Should be 0‚Äì1. More than 5 indicates main thread blocking |
| **CLS** | Should be 0. Any value suggests layout instability |
| **Slow Updates** | Should be 0. Non-zero means React renders exceed frame budget |

## Debugging Workflow

### Step 1: Baseline
1. Open a story in isolation (Canvas view)
2. Click Reset (üîÑ) to clear metrics
3. Wait 2‚Äì3 seconds for metrics to stabilize
4. Note baseline FPS, memory, and any initial issues

### Step 2: Interact
1. Perform the problematic interaction slowly
2. Watch metrics change in real-time
3. Note which metrics spike or degrade

### Step 3: Identify
1. Check the "worst" metric indicator
2. Use the timing breakdown for input issues
3. Click "Inspect" to highlight slow interaction targets
4. Cross-reference with React DevTools if needed

### Step 4: Fix & Verify
1. Make changes to address the identified issue
2. Reset metrics again
3. Repeat the interaction
4. Confirm metrics improved

---

## Common Patterns

### üêå Slow Initial Load

**Symptoms:** High mount duration, long task spikes on story change, high TBT

**Fixes:**
- Lazy load heavy dependencies with `React.lazy()`
- Defer non-critical initialization
- Memoize expensive computations with `useMemo`

### üé¢ Janky Scrolling / Animations

**Symptoms:** FPS drops below 55, high frame time, dropped frames increasing

**Fixes:**
- Use `transform` and `opacity` for animations (GPU-accelerated)
- Debounce/throttle scroll handlers
- Batch DOM reads before writes to avoid layout thrashing

### ‚è≥ Slow Click/Keyboard Response

**Symptoms:** High INP (&gt;200ms), input latency spikes

**Interpreting the timing breakdown** (`[wait Xms] ‚Üí [js Xms] ‚Üí [paint Xms]`):

| Phase | If High... | Common Causes |
|-------|------------|---------------|
| **Wait** (input delay) | Main thread blocked | Long tasks running before click |
| **JS** (processing time) | Expensive handler | Complex state updates, sync operations |
| **Paint** (presentation delay) | Expensive render | Large DOM changes, layout recalculation |

**Fixes:**
- Break up long tasks with `scheduler.yield()` or `setTimeout`
- Move expensive work to Web Workers
- Virtualize long lists
- Optimize React render paths (memoization)

### üì¶ Layout Shifts (CLS)

**Symptoms:** CLS score &gt;0, elements visually jumping

**Fixes:**
- Set `width`/`height` or `aspect-ratio` on images/videos
- Reserve space for dynamic content with `min-height`
- Use `font-display: optional` or preload fonts
- Prefer transforms over layout-affecting properties

### üîÑ React Re-render Issues

**Symptoms:** High slow updates count, P95 &gt;16ms, render cascades &gt;0

**Fixes:**
- Add `React.memo()` to pure components
- Memoize context values and callbacks
- Split contexts to reduce subscriber scope
- Move state closer to where it's used

### üî• Forced Reflows

**Symptoms:** Forced reflows &gt;0, thrashing score increasing, FPS drops

```javascript
// ‚ùå BAD: Causes forced reflow
element.style.width = '100px'
const height = element.offsetHeight  // Forces layout!

// ‚úÖ GOOD: Batch reads, then writes
const height = element.offsetHeight  // Read first
element.style.width = '100px'        // Write after
```

### üíæ Memory Issues

**Symptoms:** Memory delta growing steadily, GC pressure &gt;1 MB/s

**Fixes:**
- Clean up event listeners in `useEffect` return
- Implement LRU caches with size limits
- Use `WeakMap`/`WeakSet` for object references

---

## Metric Correlations

| If you see... | Also check... | Likely cause |
|---------------|---------------|--------------|
| Low FPS + High Long Tasks | TBT, Longest Task | Heavy JS execution |
| Low FPS + High Style Writes | Thrashing, Forced Reflows | Layout thrashing |
| High INP + High Wait phase | Long Tasks | Blocked main thread |
| High INP + High JS phase | Slow Updates, P95 | Expensive handlers |
| High INP + High Paint phase | CLS, DOM Churn | Expensive rendering |
| Rising Memory + High DOM Churn | DOM Elements | DOM leak |
| Render Cascades &gt; 0 | Slow Updates | useLayoutEffect issues |
