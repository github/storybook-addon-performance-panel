name: Changeset Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, labeled, unlabeled]

permissions:
  contents: read

jobs:
  changeset:
    name: Changeset
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check for changeset
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip changeset') }}
        run: |
          changesets=$(git diff --name-only origin/main...HEAD -- '.changeset/*.md' | grep -v 'README.md' || true)
          if [ -z "$changesets" ]; then
            echo "::error::No changeset found. Add one with 'npx changeset' or apply the 'skip changeset' label."
            exit 1
          fi
          echo "Found changeset(s):"
          echo "$changesets"
      - name: Skipped
        if: ${{ contains(github.event.pull_request.labels.*.name, 'skip changeset') }}
        run: echo "Changeset check skipped via label"
